<!DOCTYPE html>
<meta charset="utf-8">
<!-- <link rel="stylesheet" type="text/css" href="light.css"/> -->
<link rel="stylesheet" type="text/css" href="light.css" />

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <div>
        <ul>
            <li><a href="final.html"> Poverty </a></li>
            <li><a href="pop.html"> Population </a></li>
        </ul>
    </div>
    <script>
        var width = 960,
            height = 600;

        function formatSales(val) {
            var prefix = d3.formatPrefix(val),
                format = d3.format(".1f");
            return format(prefix.scale(val)) + prefix.symbol;
        }

        var formatRatio = d3.format("%");

        var formatNum = d3.format(".1");

        var path = d3.geo.path()
            .projection(null);

        var radius = d3.scale.sqrt()
            .domain([0, 1e6])
            .range([0, 8]);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        //add legend
        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(" + (width - 50) + "," + (height - 20) + ")")
            .selectAll("g")
            .data([1e6, 5e6, 1e7])
            .enter().append("g");

        legend.append("circle")
            .attr("cy", function(d) {
                return -radius(d);
            })
            .attr("r", radius);

        legend.append("text")
            .attr("y", function(d) {
                return -2 * radius(d);
            })
            .attr("dy", "1.3em")
            .text(d3.format(".1s"));

        var barTooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            .style("width", 600);
        var barAside = d3.select("body").append("div")
            .attr("class", "aside")
            .style("opacity", 0)
            .style("width", 600);
        var ageAside = d3.select("body").append("div")
            .attr("class", "ageAside")
            .style("opacity", 0)
            .style("width", 600);
        var title = d3.select("body").append("div")
            .attr("class", "title")
            .style("opacity", 0)
            .style("width", 600);




        //read in data
        queue()
            .defer(d3.json, "pop.json") //our topojson from before
            .defer(d3.csv, "pop.csv") //our data for the bar chart

        .await(ready); //ready is the function name

        function ready(error, us, dat) {
            if (error) throw error;


            svg.append("path")
                .datum(topojson.feature(us, us.objects.nation))
                .attr("class", "land")
                .attr("d", path);

            svg.append("path")
                .datum(topojson.mesh(us, us.objects.states, function(a, b) {
                    return a !== b;
                }))
                .attr("class", "border border--state")
                .attr("d", path);

            svg.append("g")
                .attr("class", "bubble")
                .selectAll("circle")
                .data(topojson.feature(us, us.objects.counties).features
                    .sort(function(a, b) {
                        return b.properties.profit - a.properties.profit;
                    }))
                .enter().append("circle")
                .attr("transform", function(d) {
                    return "translate(" + path.centroid(d) + ")";
                })
                .attr("r", function(d) {
                    return radius(d.properties.profit);
                })

            .on("mouseover", function(d) {

                    var circleId = d.id;
                    barTooltip.transition()
                        .duration(500)
                        .style("opacity", .7);

                    var tip = "<h3>" + d.properties.name + "</h3>";
                    var tip = tip + "<strong>Poverty count:</strong> " + formatSales(d.properties.profit) + "<br/>";


                    barTooltip.html(tip)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px");

                    //Now add some bars representing category sales in the county
                    //  This is long but yeilds a great result. In my other D3 course you
                    //  go into detail about making bar charts to understand this further.
                    var bar = []

                    dat.filter(function(d) {
                            return d.Id2 == circleId;
                        })
                        .forEach(function(r) {
                            bar.push({
                                name: r.Geography,
                                values: [+r['Male'], +r['Female']]
                            })
                        });
                    bar.forEach(function(b) {
                        console.log(bar);
                        render(b);
                    });


                    function render(bar) {

                        var width = 420,
                            barHeight = 20;

                        var x = d3.scale.linear()
                            .domain([0, d3.max(bar.values)])
                            .range([0, width - 200]);

                        var chart = d3.select(".tooltip").append("svg")
                            .attr("width", width)
                            .attr("height", barHeight * bar.values.length);


                        var rectangle = chart.selectAll("g")
                            .data(bar.values)
                            .enter().append("g")
                            .attr("transform", function(d, i) {

                                return "translate(0," + i * barHeight + ")";
                            });

                        rectangle.append("rect")

                        .attr("width", function(d) {
                                return x(d);
                            })
                            .attr("height", barHeight - 1);


                        rectangle.append("text")
                            .attr("x", function(d) {
                                return x(d) - 50;
                            })
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .text(function(d) {
                                return d;
                            });
                        rectangle.append("text")
                            .attr("x", 3)
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .text(function(d, i) {
                                if (i == 0) {
                                    return "Male";
                                } else {
                                    return "Female";
                                }
                            });

                    }
                })
                .on("mouseout", function(d) {
                    barTooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
                .on("click", function(d) {

                    var circleId = d.id;

                    //pie chart
                    barAside.transition()
                        .duration(200)
                        .style("opacity", .9);

                    barAside.style("left", 1050 + "px")
                        .style("top", 180 + "px")
                        .html("");

                    //county heading
                    title.transition()
                        .duration(200)
                        .style("opacity", .9);
                        var blah = "<h1>" + d.properties.name + "</h1>";
                    title.style("left", 1050 + "px")
                        .style("top", 100 + "px")
                        .html(blah);

                    //age pie chart

                    ageAside.transition()
                        .duration(200)
                        .style("opacity", .9);

                    ageAside.style("left", 1050 + "px")
                        .style("top", 400 - 20 + "px")
                        .html("");

                    ethinicity();
                    age();

                    function ethinicity() {
                    var radius = 74,
                        padding = 10;

                    var color = d3.scale.ordinal()
                        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

                    var arc = d3.svg.arc()
                        .outerRadius(radius)
                        .innerRadius(radius - 30);

                    var pie = d3.layout.pie()
                        .sort(null)
                        .value(function(d) {
                            return d.population;
                        });

                    color.domain(d3.keys(dat[0]).filter(function(key) {
                        return key == "White" || key == "Black" || key == "AmericanIndian" || key == "Indian" || key == "Hawaiian" || key == "Other" || key == "Chinese" || key == "Filipino" || key == "Japanese" || key == "Korean" ||
                            key == "Vietnamese";
                    }));



                    dat.forEach(function(d) {
                        d.ages = color.domain().map(function(name) {
                            return {
                                name: name,
                                population: +d[name]
                            };
                        });
                    });

                    if (!document.getElementById("legend2")) {

                        var legend2 = d3.select(".aside").append("svg")
                            .attr("id", "legend2")
                            .attr("width", radius * 2)
                            .attr("height", radius * 2 + 30)
                            .attr("bottom", 50)
                            .selectAll("g")
                            .data(color.domain().slice().reverse())
                            .enter().append("g")
                            .attr("transform", function(d, i) {
                                return "translate(0," + i * 20 + ")";
                            });

                        legend2.append("rect")
                            .attr("width", 18)
                            .attr("height", 18)
                            .style("fill", color);

                        legend2.append("text")
                            .attr("x", 24)
                            .attr("y", 9)
                            .attr("dy", ".35em")
                            .text(function(d) {
                                return d;
                            });
                    }



                    var svg = d3.select(".aside").selectAll(".pie")
                        .data(dat.filter(function(d) {
                            return d.Id2 == circleId;
                        }))
                        .enter()
                        .append("svg")
                        .attr("class", "pie")
                        .attr("width", radius * 2)
                        .attr("height", radius * 2)
                        .append("g")
                        .attr("transform", "translate(" + radius + "," + radius + ")");

                    svg.selectAll(".arc")
                        .data(function(d) {
                            return pie(d.ages);
                        })
                        .enter().append("path")
                        .attr("class", "arc")
                        .attr("d", arc)
                        .style("fill", function(d) {
                            return color(d.data.name);
                        });


                    svg.append("text")
                        .attr("dy", ".35em")
                        .style("text-anchor", "middle")
                        .text(function(d) {
                            console.log(d)
                            return "Ethinicity";
                        });

                  }


                  function age() {
                  var radius = 74,
                      padding = 10;

                  var color = d3.scale.ordinal()
                      .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

                  var arc = d3.svg.arc()
                      .outerRadius(radius)
                      .innerRadius(radius - 30);

                  var pie = d3.layout.pie()
                      .sort(null)
                      .value(function(d) {
                          return d.population;
                      });
                      //under5,5-9,10-14,15-19,20-14,25-34,35-44,45-54,55-59,60-64,65-74,75-84,over85
                  color.domain(d3.keys(dat[0]).filter(function(key) {
                      return key == "under5" || key == "5-9" || key == "10-14" || key == "15-19" || key == "20-14" || key == "25-34" || key == "35-44" || key == "45-54" || key == "55-59" || key == "60-64" || key == "65-74" ||key == "75-84" ||key == "over85";
                  }));



                  dat.forEach(function(d) {
                      d.hi = color.domain().map(function(name) {
                          return {
                              name: name,
                              population: +d[name]
                          };
                      });
                  });

                  if (!document.getElementById("legend3")) {

                      var legend3 = d3.select(".ageAside").append("svg")
                          .attr("id", "legend3")
                          .attr("width", radius * 2)
                          .attr("height", radius * 2 + 30)
                          .attr("bottom", 50)
                          .selectAll("g")
                          .data(color.domain().slice().reverse())
                          .enter().append("g")
                          .attr("transform", function(d, i) {
                              return "translate(0," + i * 20 + ")";
                          });

                      legend3.append("rect")
                          .attr("width", 18)
                          .attr("height", 18)
                          .style("fill", color);

                      legend3.append("text")
                          .attr("x", 24)
                          .attr("y", 9)
                          .attr("dy", ".35em")
                          .text(function(d) {
                              return d;
                          });
                  }



                  var svg = d3.select(".ageAside").selectAll(".pie")
                      .data(dat.filter(function(d) {
                          return d.Id2 == circleId;
                      }))
                      .enter()
                      .append("svg")
                      .attr("class", "pie")
                      .attr("width", radius * 2)
                      .attr("height", radius * 2)
                      .append("g")
                      .attr("transform", "translate(" + radius + "," + radius + ")");

                  svg.selectAll(".arc")
                      .data(function(d) {
                          return pie(d.hi);
                      })
                      .enter().append("path")
                      .attr("class", "arc")
                      .attr("d", arc)
                      .style("fill", function(d) {
                          return color(d.data.name);
                      });


                  svg.append("text")
                      .attr("dy", ".35em")
                      .style("text-anchor", "middle")
                      .text(function(d) {
                          console.log(d)
                          return "Age";
                      });

                }



                });

        }

        d3.select(self.frameElement).style("height", height + "px");
    </script>
